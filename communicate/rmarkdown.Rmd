---
title: "R Markdownのすゝめ"
author: "さんぽう"
date: "`r format(Sys.Date(), format = '%Y年%m月%d日')`"
output:
  html_notebook:
    code_folding: show
    fig_caption: yes
    fig_height: 6
    highlight: textmate
    md_extensions: -ascii_identifiers
    number_sections: no
    theme: cerulean
    toc: yes
    toc_float:
      collapsed: no
      smooth_scroll: no
  html_document:
    code_folding: show
    fig_caption: yes
    fig_height: 6
    highlight: textmate
    md_extensions: -ascii_identifiers
    number_sections: yes
    theme: cerulean
    toc: yes
    toc_float:
      collapsed: no
      smooth_scroll: no
---

```{r setup, include=FALSE}
# 共通chunkオプションの指定
knitr::opts_chunk$set(warning = FALSE, echo = TRUE)

# データハンドリングで利用する外部パッケージの読み込み
require(tidyverse)
# 表示で利用する外部パッケージの読み込み
require(gridExtra)
require(DT)
require(knitr)
require(extrafont)

tidyverse::tidyverse_conflicts()

# DT::datatableオプションの設定
class <- c("display compact")
style <- c("bootstrap")
```

# はじめに {.tabset}
本資料は[データ分析勉強会][1]で講義した「R Markdownのすゝめ」をベースに整理したものです。講義では説明を行わなかった日本語を含むPDFファイルの作成についても触れています。本資料がHTML形式の場合、Rのコードを参照するには右側にある**`[Code]`**ボタンをクリックして下さい。なお、JavaScriptは必ずOnにしてご覧下さい。  

## 権利と免責 {.unnumbered}
* 本資料の著作権は原則として著作者に帰属します。ただし、引用した演習の設問等の著作権は原著作者が所有しています。
* 本資料は無保証です。本資料を使用することによって生じる、いかなる直接的・間接的損害について著作者はいかなる責任、サポート義務を負いません。

## ライセンス {.unnumbered}
![CC BY-NC-SA 4.0](https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png) 本資料は[クリエイティブ・コモンズ 表示 - 非営利 - 継承 4.0 国際ライセンス](http://creativecommons.org/licenses/by-nc-sa/4.0/deed.ja)の下に提供されています。

# R Markdown
Reproducible Reseach

## その分析、再現出来ますか？
[データ分析勉強会][1]では、主に[R Commander（以降、Rcmdrと記述）][2]を使って分析をしています。GUIで操作は簡単ですがGUIであるが故にコンソール出力は残るものの分析過程が記録しにくいという面もあります。

Rcmdrでの操作の特徴
* GUIで簡単ではあるが__メニュー操作自体__は記録に残らない
* データセットの__切り替え__をコンソールに出力しない
* 操作とコンソール出力を一致させて記録するのが一苦労
* NAが含まれたデータを操作するとRcmdr自体が落ちることがある

Rcmdrのグラフィックデバイスの特徴
* 記録開始操作を行わないとヒストリが残らない
* ヒストリ機能を使うと表示が崩れて戻らない時がある

このような条件の元で分析の報告書を作成するには、コンソールに出力されたコードやコンソールの計算結果をテキストとして保存し、グラフィックデバイスの出力は画像として保存し、手間暇かけてコピペを行っていく必要があります。その場の記憶に頼った作業になりますので後から見てコードと出力結果の組合せが正しいかどうか分からなくなってる可能性が高くなります。いわゆるコピペ汚染で、データが変わってもまったく同じ分析が出来るかどうか怪しいくなります。

## そこで、R Markdown
[R Markdown][3]は[RStudio][4]が中心となって開発しているオーサリング・フォーマットです。[R][0]による分析と分析結果の報告を簡単な書式（markdown記法）で、ひとつのドキュメントにまとめる事ができ分析の再現性が確保できるとともに分析過程の透明性も確保できるようになります。
このような自然言語（日本語、英語等）で記載した文書中にコードを織り込んでいくプログラミング・スタイルを文芸的プログラミングと呼び、[RStudio][4]では更に一歩進めた[R Notebooks][6]という機能で提供しています。[R Notebooks][6]については、別の機会に紹介します。

## 使うためには？
### 必要な環境
R Markdownを使うためには[RStudio Desktop][5]を導入するのが一番簡単です。最低限、必要なものは以下の通りです。

* R
* RStudio Desktop
* knitrパッケージ
* rmarkdownパッケージ

PDFフォーマットの文書を作成したい場合は、別途、TeX環境を準備して下さい。TeX環境としては広く使われている[TeX Live][7]がおすすめです。また、[pandoc][8]というプログラムも必要ですがRStudioに同梱されていますので、別途、インストールする必要はありません。なお、ここでは、[RStudio Desktop][5]のインストール方法や使い方は省略します。

#### パッケージのインストール
必要なパッケージは[CRAN][0]からインストールします。[RStudio Desktop][5]のパッケージ・マネージャからインストールするか、以下のコマンドを用います。パッケージに必要な依存関係のあるパッケージも同時にインストールされます。

```{r, eval=FALSE}
install.packages("rmarkdown")
```

#### 設定の変更
パッケージのインストールが終了しましたら[RStudio Desktop][5]の設定を変更しておきます。メニューから［Tools］-［Global Options...］-［Sweave］を選択します。

![設定画面](./fig/rstudio_sweave_option.jpg)

一番上にある［Weave Rnw files using:］を［knitr］に変更します。

### 作成できる文書
[R Markdonw][3]を用いて作成できる文書は、ドキュメント（文書）、スライドショー文書、インタラクティブ文書の3種類で各文書毎に複数のフォーマットを選ぶ事ができます。

Type         | Format
------------ | --------------------
Document     | HTML  
　           | PDF  
　           | docx (MS Word)
Presentation | IO-slides (HTML5)
　           | HTML Slidy (XHTML)
　           | Beamer (PDF)
Interactive  | HTML (shiny)
　           | IO-slides (shiny)

各フォーマットはテンプレートが準備されていますので、作成したいフォーマットに合わせてテンプレートを選択して下さい。ただし、日本語を含むPDFファイルを作成する場合はテンプレートの改修が必要になります。

### R Markdownを体験する
[R Markdown][3]の便利さ有益さを実感するためにHTMLファイルを作成してみましょう。HTMLファイルを作成するためにはメニューの［File］-［New File］-［R Markdonw...］でテンプレートの選択ウィンドウを開いて［Document］-［HTML］を選択します。

![テンプレート選択ウィンドウ](./fig/new_r_markdown.jpg)

［Title］と［Author］は後から変更ができますので、そのままで構いません。［OK］ボタンをクリックするとテンプレートが開かれますので任意の名前で保存します。

![knitボタン](./fig/knit_document.png)

ファイルを保存しましたら、エディタの上部にある［knit］ボタンをクリックします。自動的にファイルのコンパイルが始まりViewerペインに結果が出力されます。

![出力結果](./fig/knit_result.jpg)

これだけで報告と分析結果の入ったHTMLファイルが出来上がります。

## R Markdownの書式
では、具体的に[R Markdown][3]を作成する際に必要な書式について見てみましょう。作成したファイルを見るとわかりますが、大きく分けて3つのパードから成っているのがわかります。

Part     | Description
-------- | -------------------------------------------------------------
YAML     | 文書最初にある3連のハイフン（-）で囲まれた部分
markdown | YAMLでもchunkでもない文書が記載されている部分
chunk    | 3連の半角バッククォート（｀）で囲まれたコードが記載された部分

この3つのパートの記述を理解すれば[R Markdown][3]文書を作成できるようになります。なお、[チートシート][9]が公開されていますので、ダウンロードしておくことをおすすめします。

### YAML
YAML(YAML Ain't a Markup Language)は構造化されたデータを表現するための記法です。出力する文書をコントロールするためのパラメータを記述します。基本的な設定は［knit］ボタンの隣にある歯車ボタンから選択できるオプションメニューから設定できます。設定可能項目の詳細については[チートシート][9]を参照してください。

### markdown
markdownは軽量markup言語と呼ばれるもので比較的簡単な記述で文書体裁を指定することができます。markdownには処理環境により方言がありますが[R Markdown][3]で使用できるのは[pandoc][8]のmarkdownです。markdown記法の詳細は[チートシート][9]や[リファレンスガイド][10]、ヘルプ（Markdown Quick Reference）から参照することが可能です。

### chunk
chunkは[R][0]のコードを記述する部分です。{}で囲まれた部分でオプションを指定することによりchunkの動作制御が可能です。チャンクオプションは以下の形式で指定します。

```{r, eval=FALSE}
{r chunk.name, option=value, ...}
```

`chunk.name`は一意のchunk名を指定する必要がありますが、省略も可能です。`option`はchunkの動作制御を行うためのオプションを指定します。代表的なものとしては以下があります。詳細は[チートシート][9]や[リファレンスガイド][10]で確認して下さい。

option  | description
------- | ---------------------------------------
eval    | chunk内のRのコードを実行するか否か
echo    | chunk自体をドキュメントに出力するか否か
include | chunk自体と実行結果を出力するか否か

### setup chunk
[RStudio Desktop][5]v0.99.878以降に実装されているテンプレートにchunkオプションを一括指定できるsetup chunkが追加されています。setup chunkで指定されたchunkオプションは全chunkに対して有効になります。

### inline chunk
markdown中で[R][0]の計算結果等を参照する場合は半角バッククォート（｀）で囲まれたinline chunkを利用します。例えば以下のように使います。

```{r, eval=FALSE}
p値(`r result$p.value`)が0.05未満であるため、検定結果は有意と見なせる。
```

## 制限事項等
[R Markdown][3]は英語圏で開発されているため日本語等のいわゆるマルチバイト文字を使う場合には様々な不都合が出てきます。ここでは、それらの不都合と回避方法を紹介します。

### TOCのリンクが機能しない
HTMLフォーマットの文書を作成した際にTOC(Table Of Contents)に日本語が含まれている場合に起きる事象です。原因は[pandoc][8]のデフォルト設定に起因するのですが、TOCに日本語を含める場合はYAMLに以下の設定を追加して下さい。
```{r, eval=FALSE}
---
output:
  html_document:
    md_extensions: -ascii_identifiers
---
```

## RcmdrでR Markdown
[Rcmdr][2]を使っている方は[R][0]でコードを書くのは敷居が高いと思っている方も多いと思います。最近の[Rcmdr][2]は実行したコマンドを全て［Rマークダウン］タブの中に[R Markdown][3]として記録してくれていますので、この出力結果を保存しYMAL等を整えknitすれば[R Markdown][3]文書が出来上がります。

## おすゝめオプション
### Floating TOC
HTMLフォーマットで出力する際におすゝめなのが、[rmarkdown][11]v0.95から追加されたFloating TOCです。常にTOCが文書の左上に表示されるようになります。利用する場合はYAMLに以下の設定を追加して下さい。

```{r, eval=FALSE}
---
output: 
  html_document: 
    toc: yes
    toc_float: yes
---
```

TOCの折りたたみとスクロースの設定も可能です。
```{r, eval=FALSE}
---
output: 
  html_document: 
    toc: yes
    toc_float:
      collapsed: no
      smooth_scroll: no
---
```

### Code Folding
同じくHTMLフォーマットで出力する際におすゝめなのが、[rmarkdown][11]v0.95から追加されたCode Foldingです。コードの表示・非表示を最初に決めておくことができ、選択ボタンにより表示・非表示を切り替えることが可能です。利用する場合はYAMLに以下の設定を追加して下さい。

```{r, eval=FALSE}
---
output: 
  html_document: 
    code_folding: hide
---
```

デフォルトで表示する場合は`show`を非表示にする場合は`hide`を指定して下さい。

### Tabbed Section
こちらもHTMLフォーマットで出力する際におすゝめなのが、[rmarkdown][11]v0.95から追加されたTabbed Sectionです。セクションをタブ形式で表示できるようになります。この機能はYAMLでなくmarkdwon中で指定します。

```{r, eval=FALSE}
## Tabbed Section {.tabset}

### Tab 1 {.unnumbered}
(tab content)

### Tab 2 {.unnumbered}
(tab content)

## Normal Section
```

タブは指定したセクションの一つ下の階層のみで有効になります。また、タブ指定したセクション以下でネストすることも可能です。ただし、タブ表示されるセクション名は一意であることが条件になります。詳細は[R Markdown][3]で確認して下さい。

![Tabbed Section](./fig/tabbed_section.jpg)

# 日本語PDF
PDFフォーマットの文書を作成するには、別途、[TeX/LaTeX][12]が必要です。[TeX/LaTeX][12]には様々なディストリビューションがありますが、フリーでメジャーなディストリビューションである[TeX Live][7]がおすすめです。

## 準備
### TeX/LaTeXのインストール
[TeX Live][7]をscheme-fullでインストールして下さい。ネットワーク環境やマシンスペックにもよりますが、3時間程度かかる場合もありますので作業時間には余裕を見て下さい。

### LaTeXエンジンの設定
[TeX Live][7]をscheme-fullでインストールしていますので、様々なLaTeXエンジンが使えますが[RStudio Desktop][5]で手軽に使えるのは[XeLaTeX][13]です。[RStudio Desktop][5]ではメニューの［Tools］-［Global Options...］-［Sweave］を選択します。

![設定画面](./fig/rstudio_sweave_option.jpg)

二番目にある［Typset LaTeX into PDF using:］を［XeLaTeX］に変更します。なお、選択肢にない他のエンジンを使いたい場合は[環境変数を設定][14]して下さい。

### YAMLの設定
PDFで日本語を表示するためにはYAMLで日本語フォント等を指定する必要があります。

```{r, eval=FALSE}
---
output: 
  pdf_document: 
    latex_engine: xelatex
header-includes: 
  - \usepackage{xltxtra}
  - \usepackage{zxjatype}
  - \usepackage[ipa]{zxjafont}
  - \setmainfont{IPAPMincho}
  - \setsansfont{IPAPGothic}
  - \setmonofont{Yutapon-coding-Demi-Bold}
  - \setjamainfont{IPAPMincho}
  - \setjasansfont{IPAPGothic}
  - \setjamonofont{Yutapon-coding-Demi-Bold}
documentclass: article
classoption: a4paper, 12pt, ja=standard
geometry: no
---
```

`usepackage`の指定はXeLaTeXで日本語フォントを扱うための指定です。この例では[IPAフォント][15]を利用するための指定です。Windows環境でMicrosoftのフォントを使う場合は`ipa`の部分を`ms`に変更して下さい。
`set****font`ならびに`setj****font`は個別にフォントを指定した場合に記述します。

option | description
------ | ------------
main   | Serifフォントの指定
sans   | Sans Serifフォントの指定
mono   | Monotype (等幅)の指定

### グラフ中の日本語
グラフ中に日本語が含まれる場合、PDF作成時にエラーとなったり、いわゆる豆腐文字となったりして日本語が表示されない場合があります。この場合は、`extrafont`パッケージを用います。

### TeX数式中の日本語
HTMLフォーマットの場合、[MathJax][16]で処理されるために日本語表示が可能ですが、本来、TeXの数式モードでは日本語（ひらがな、カタカナ、漢字、記号のいずれも）の使用は認められていません。日本語を使う場合は`\mbox{日本語の記述}`を利用して下さい。

### ％文字の扱い
markdown中で半角の％文字を使うとPDF作成時にエラーが出る場合があります。その場合は`\%`と表記して下さい。

### 太文字・斜体字
利用しているフォントによっては太文字・斜体字指定を行っても太文字・斜体字にならない場合があります。これは指定しているフォント中にBold/Italic体の情報が見つからないためです。別のフォントを指定して下さい。

---

[0]: https://cran.r-project.org/ "CRAN"
[1]: https://sites.google.com/site/kantometrics/ "データ分析勉強会"
[2]: https://cran.r-project.org/web/packages/Rcmdr/index.html "R Commander"
[3]: http://rmarkdown.rstudio.com/index.html "R Markdown from RStudio"
[4]: https://www.rstudio.com/ "RStudio"
[5]: https://www.rstudio.com/products/RStudio/ "RStudio Desktop"
[6]: http://rmarkdown.rstudio.com/r_notebooks.html "R Notebooks"
[7]: https://texwiki.texjp.org/?TeX%20Live "TeX Live"
[8]: http://pandoc.org/ "pandoc"
[9]: https://www.rstudio.com/wp-content/uploads/2016/03/rmarkdown-cheatsheet-2.0.pdf "R Markdown Cheat Sheet"
[10]: https://www.rstudio.com/wp-content/uploads/2015/03/rmarkdown-reference.pdf "R Markdown Reference Guide"
[11]: https://cran.r-project.org/web/packages/rmarkdown/index.html "rmarkdown package"
[12]: https://texwiki.texjp.org/ "TeX Wiki"
[13]: https://texwiki.texjp.org/?XeTeX "XeTeX"
[14]: https://support.rstudio.com/hc/en-us/articles/200532257-Customizing-LaTeX-Options "Customizing LaTeX Options"
[15]: http://ipafont.ipa.go.jp/ "IPA Font"
[16]: https://www.mathjax.org/ "MathJax, Beautiful math in all browsers"

[]: http://gihyo.jp/admin/serial/01/r-markdown "R Markdownで楽々レポートづくり"
